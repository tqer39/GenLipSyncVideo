#!/bin/bash

set -ex  # ã‚¨ãƒ©ãƒ¼æ™‚ã«å³çµ‚äº†

# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡ºåŠ›é–¢æ•°
function echo_success() { echo -e "\033[32mğŸ‰ [SUCCESS] $1\033[0m"; }
function echo_warning() { echo -e "\033[33mâš ï¸ [WARNING] $1\033[0m"; }
function echo_error() { echo -e "\033[31mâŒ [ERROR] $1\033[0m"; }
function echo_info() { echo -e "\033[34mâ„¹ï¸ [INFO] $1\033[0m"; }

# å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo_info "Ubuntu ã®å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
sudo apt update
sudo apt install -y \
    build-essential \
    cmake \
    clang \
    libsox-dev \
    ffmpeg \
    libasound-dev \
    portaudio19-dev \
    libportaudio2 \
    libportaudiocpp0 \
    python3-pip \
    python3-venv \
    git

# anyenv ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
if ! command -v anyenv >/dev/null; then
    echo_info "anyenv ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    git clone https://github.com/anyenv/anyenv ~/.anyenv
    export PATH="$HOME/.anyenv/bin:$PATH"
    ~/.anyenv/bin/anyenv install --init
else
    echo_success "anyenv ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚"
fi

# anyenv ã§ pyenv ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
if ! command -v pyenv >/dev/null; then
    echo_info "pyenv ã‚’ anyenv ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    anyenv install pyenv
    export PATH="$HOME/.anyenv/envs/pyenv/bin:$PATH"
else
    echo_success "pyenv ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚"
fi

# pyenv ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
echo_info "Python 3.13.0 ã‚’ pyenv ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
eval "$(pyenv init --path)"
pyenv install -s 3.13.0
pyenv local 3.13.0

# Homebrew ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
if ! command -v brew >/dev/null; then
    echo_info "Homebrew ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
else
    echo_success "Homebrew ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚"
fi

# uv ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
if ! command -v uv >/dev/null; then
    echo_info "uv ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    brew install uv
else
    echo_success "uv ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚"
fi

# uv ä»®æƒ³ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
echo_info "uv ä»®æƒ³ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
uv venv --python 3.10.0
# shellcheck source=/dev/null
source ".venv/bin/activate"

# Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
echo_info "Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªä¸­..."
python -V

# pip ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
echo_info "pip ã‚’ä»®æƒ³ç’°å¢ƒå†…ã§ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä¸­..."
uv pip install --upgrade pip

# Hugging Face CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
if ! command -v huggingface-cli >/dev/null; then
    echo_info "Hugging Face CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    pip install huggingface-hub
else
    echo_success "Hugging Face CLI ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚"
fi

# ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
echo_info "Hugging Face CLI ã§ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."
huggingface-cli download fishaudio/fish-speech-1.4 --repo-id --revision main

# uv ã§å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo_info "uv ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
uv add torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1
uv add --dev --python 3.10.0

# å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
echo_success "ã™ã¹ã¦ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"

# FS_ROOT="$HOME/workspace/fish-speech"

# # å¿…è¦ãªã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# sudo apt update
# sudo apt install -y \
#     build-essential \
#     cmake \
#     clang \
#     libsox-dev \
#     ffmpeg \
#     libasound-dev \
#     portaudio19-dev \
#     libportaudio2 \
#     libportaudiocpp0 \
#     python3-pip \
#     python3-venv \
#     git

# # huggingface_hub ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# pip install huggingface_hub

# # huggingface-cli ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
# if ! command -v huggingface-cli &> /dev/null; then
#     echo "huggingface-cli ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
#     exit 1
# fi

# if [ ! -d "$FS_ROOT" ]; then
#     mkdir -p "$HOME/workspace"
#     git clone https://github.com/fishaudio/fish-speech "$FS_ROOT"
#     cd ./fish-speech
# fi

# git -C "$FS_ROOT" switch main
# git -C "$FS_ROOT" fetch -p
# git -C "$FS_ROOT" pull

# # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
# cd "$FS_ROOT"

# # ä»®æƒ³ç’°å¢ƒã®ä½œæˆ
# PYTHON_VERSION=3.10.0
# uv venv --python "$PYTHON_VERSION"
# # shellcheck source=/dev/null
# source .venv/bin/activate
# python -V
# uv pip install --upgrade pip
# uv add --dev --python "$PYTHON_VERSION" torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1
# uv add --dev --python "$PYTHON_VERSION" click pydub fish-audio-preprocess

# # ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
# mkdir -p "$FS_ROOT/models/checkpoints"

# # ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
# huggingface-cli download fishaudio/fish-speech-1.4 \
#     --local-dir "$HOME/workspace/GenLipSyncVideo/models/checkpoints/fish-speech-1.4"

# mkdir -p ./data/raw/separate
# mkdir -p ./data/speech-to-text

# echo "ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
